# useful sources 
# https://github.com/wincent/wincent/blob/c02f91d6821f/aspects/dotfiles/files/.config/tmux/tmux.conf

# hidden variables were added in 3.2, so it is earliest supported version

%hidden TMUX_VERSION="#{s|next-||:#{version}}"
%hidden IS_TMUX_3_3_OR_ABOVE="#{e|>=|f|0:$TMUX_VERSION,3.3}"
%hidden IS_TMUX_3_4_OR_ABOVE="#{e|>=|f|0:$TMUX_VERSION,3.4}"
%hidden IS_TMUX_3_5_OR_ABOVE="#{e|>=|f|0:$TMUX_VERSION,3.5}"

# Use 24 bit terminal colors
set -sa terminal-overrides ",$TERM:RGB"

# Change prefix to `Ctrl+a`
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# Splits open in current path
unbind-key '"'
unbind-key %
bind-key | split-window -h -c "#{pane_current_path}"
bind-key - split-window -v -c "#{pane_current_path}"

# Windows open in current path
unbind-key c
bind-key c new-window -c '#{pane_current_path}'

bind-key -r '<' swap-window -d -t '{previous}' # Move window left.
bind-key -r '>' swap-window -d -t '{next}' # Move window right.

# Set vi 
set-window-option -g mode-keys vi

# use emacs keys for the command line
set -g status-keys emacs

# Visual block mode and line copying
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind-key -T copy-mode-vi y send-keys -X copy-selection
bind-key -T copy-mode-vi Y send-keys -X copy-line \; display-message 'opied-line'

# TODO: attempt to bind yy to copy line and retain copy-selection functionality
# bind-key -T test-table q switch-client -T root  # Return to normal
# bind-key -T copy-mode-vi y switch-client -T test-table \; send-keys -X copy-selection
# bind-key -T test-table y send-keys -X copy-line \; send-keys -X copy-selection-pipe ""

# Mouse options
set -g mouse on
bind-key -T copy-mode-vi DoubleClick1Pane send-keys -X select-line
bind-key -T copy-mode MouseUp1Pane send-keys -X select-word

# stay in copy mode on line drag end
unbind-key -T copy-mode MouseDragEnd1Pane

# Always pass -H to copy mode to not display search counter
bind-key [ copy-mode -H
bind-key PPage copy-mode -u -H
bind-key -T root MouseDrag1Pane if-shell -F "#{||:#{pane_in_mode},#{mouse_any_flag}}" {
  send-keys -M
} {
  copy-mode -M -H
}
bind-key -T root WheelUpPane if-shell -F "#{||:#{pane_in_mode},#{mouse_any_flag}}" {
  send-keys -M
} {
  copy-mode -e -H
}

# Enter is wrong
bind-key -T copy-mode-vi Escape send-keys -X clear-selection

# Fast reload settings
bind r source-file ~/.config/tmux/tmux.conf

# Add scroll back history
set -g history-limit 10000

# Window and pane index starts at 1 rather than 0
set -g base-index 1
set -g pane-base-index 1

set -g renumber-windows on

# Enable status bar and pane status
set-option -g status "on"
set -g status-interval 1
set -g status-left-length 30
set -g status-right-length 150

set-option -g pane-border-lines single
set-option -g pane-border-status bottom

# Display messages for 4 seoncds
set -g display-time 4000

# Copy-mode display 
%hidden IS_COPY_MODE="#{==:#{pane_mode},copy-mode}"
%hidden COPY_MODE_MARKER="#[align=left#, fg=yellow]COPY#[default]"
%hidden COPY_MODE_LEFT="$COPY_MODE_MARKER"
%hidden HAS_SEARCH_RESULT="#{&&:#{e|>|:#{search_count},0},#{search_present}}"
%hidden RESULT_OR_RESULTS="result#{?#{==:#{search_count},1},,s}"
%hidden RESULT_COUNT_IS_PARTIAL="#{e|>|:#{search_count_partial},0}"
%hidden SEARCH_RESULT_COUNT="(#{search_count}#{?$RESULT_COUNT_IS_PARTIAL,+,} $RESULT_OR_RESULTS)"
%hidden OFFSET_FROM_TOP="#{e|-|:#{history_size},#{scroll_position}}"
%hidden COPY_MODE_LOCATION="[$OFFSET_FROM_TOP/#{history_size}]"
%hidden COPY_MODE_CENTER="#[align=centre#,bg=black]#[default]"
# %hidden COPY_MODE_RIGHT=""
%hidden COPY_MODE_RIGHT="#[align=right#, fg=yellow]#{?$HAS_SEARCH_RESULT,$SEARCH_RESULT_COUNT  ,}$COPY_MODE_LOCATION#[default]"

set-option -g pane-border-format "#{?$IS_COPY_MODE,$COPY_MODE_LEFT$COPY_MODE_CENTER$COPY_MODE_RIGHT,}"

# Status Line

# colors
%hidden active_tab="white"
%hidden active_text="colour239"
%hidden inactive_tab="colour239"
%hidden inactive_tab_text="colour7"
%hidden statusbar_bg="colour237"
%hidden statusbar_fg="colour223"

%hidden prefix_on_bg="colour167"
%hidden prefix_on_fg="colour7"
%hidden prefix_off_bg="colour241"
%hidden prefix_off_fg="colour7"

%hidden inactive_command_fg=${inactive_tab_text}
%hidden inactive_command_bg=${active_text}

%hidden command_fg=${inactive_tab_text}
%hidden command_bg=${active_text}

%hidden border_color=${active_tab}
%hidden inactive_border_color=${active_text}

# Default window title colors
set-window-option -g window-status-style bg=${active_tab},fg=${statusbar_bg}

# Default window with an activity alert
set-window-option -g window-status-activity-style bg=${statusbar_bg},fg=colour248

# Active window title colors
set-window-option -g window-status-current-style bg=red,fg=${statusbar_bg}

set-option -g pane-active-border-style fg=${border_color}
set-option -g pane-border-style fg=${inactive_border_color}

# Command mode active
set-option -g message-style bg=${command_bg},fg=${command_fg}
# Command mode inactive
set-option -g message-command-style bg=${inactive_command_bg},fg=${inactive_command_fg}

# Plugins using TPM
set -g @plugin 'tmux-plugins/tpm'

set -g @plugin 'tmux-plugins/tmux-resurrect' # persistance for sessions
set -g @plugin 'tmux-plugins/tmux-continuum'

set -g @plugin "soyuka/tmux-current-pane-hostname"

# enable tmux vim-navigator (vim plugin)
source-file ~/.config/tmux/vim-navigator.tmux
source-file ~/.config/tmux/components/statusbar.tmux

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.config/tmux/plugins/tpm/tpm'
